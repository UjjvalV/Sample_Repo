{% extends 'student/base.html' %}
{% block title %}QR Scanner{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-qrcode me-2"></i>
                        QR Code Scanner
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Scanner Section -->
                    <div id="scannerSection" class="text-center">
                        <div class="mb-4">
                            <video id="scanner" width="100%" height="300" style="border: 2px solid #007bff; border-radius: 10px;"></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                        </div>
                        
                        <div class="mb-3">
                            <button id="startScan" class="btn btn-primary btn-lg">
                                <i class="fas fa-camera me-2"></i>
                                Start Scanning
                            </button>
                            <button id="stopScan" class="btn btn-danger btn-lg" style="display: none;">
                                <i class="fas fa-stop me-2"></i>
                                Stop Scanning
                            </button>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Point your camera at a QR code to scan it
                        </div>
                        
                        <div id="debugInfo" class="alert alert-warning" style="display: none;">
                            <h6>Debug Information:</h6>
                            <div id="debugContent"></div>
                        </div>
                    </div>

                    <!-- Results Section (Initially Hidden) -->
                    <div id="resultsSection" style="display: none;">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>QR Code Scanned Successfully!</h5>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">QR Code Data</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="qrDataDisplay" class="mb-3">
                                            <code id="qrData" class="small"></code>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Mode:</strong> <span id="qrMode" class="badge bg-primary"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Class ID:</strong> <span id="qrClassId" class="badge bg-info"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Teacher ID:</strong> <span id="qrTeacherId" class="badge bg-warning"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Subject ID:</strong> <span id="qrSubjectId" class="badge bg-secondary"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Timestamp:</strong> <span id="qrTimestamp" class="text-muted small"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Student Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>Student ID:</strong> <span id="studentId" class="badge bg-success"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Student Name:</strong> <span id="studentName" class="text-primary"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Roll Number:</strong> <span id="studentRoll" class="text-info"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Class/Group:</strong> <span id="studentGroup" class="text-secondary"></span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Scan Time:</strong> <span id="scanTime" class="text-muted small"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button id="scanAnother" class="btn btn-primary">
                                <i class="fas fa-qrcode me-2"></i>
                                Scan Another QR Code
                            </button>
                            <button id="markAttendance" class="btn btn-success">
                                <i class="fas fa-check me-2"></i>
                                Mark Attendance
                            </button>
                        </div>
                    </div>

                    <!-- Empty State (Initially Hidden) -->
                    <div id="emptyState" style="display: none;">
                        <div class="text-center py-5">
                            <i class="fas fa-qrcode fa-5x text-muted mb-4"></i>
                            <h4 class="text-muted">No QR Code Scanned</h4>
                            <p class="text-muted">Start scanning to see QR code data and your student information</p>
                            <button id="startScanEmpty" class="btn btn-primary btn-lg">
                                <i class="fas fa-camera me-2"></i>
                                Start Scanning
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include QR Code Scanner Libraries -->
<script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
let qrScanner = null;
let isScanning = false;
let fallbackInterval = null;

// Student information (from Django context)
const studentInfo = {
    id: '{{ user.id }}',
    name: '{{ user.username }}',
    rollNumber: '{% if student_profile %}{{ student_profile.roll_number }}{% else %}N/A{% endif %}',
    group: '{% if student_group %}{{ student_group.stream }} - {{ student_group.name }}{% else %}N/A{% endif %}'
};

// Debug function
function showDebug(message) {
    const debugInfo = document.getElementById('debugInfo');
    const debugContent = document.getElementById('debugContent');
    debugContent.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
    debugInfo.style.display = 'block';
    console.log('DEBUG:', message);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    showEmptyState();
    setupEventListeners();
    
    // Check browser compatibility
    showDebug('Page loaded. Checking browser compatibility...');
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        showDebug('Camera API supported');
    } else {
        showDebug('Camera API NOT supported');
    }
    
    if (typeof QrScanner !== 'undefined') {
        showDebug('QR Scanner library loaded');
    } else {
        showDebug('QR Scanner library NOT loaded');
    }
    
    if (typeof jsQR !== 'undefined') {
        showDebug('jsQR library loaded');
    } else {
        showDebug('jsQR library NOT loaded');
    }
});

function setupEventListeners() {
    document.getElementById('startScan').addEventListener('click', startScanning);
    document.getElementById('startScanEmpty').addEventListener('click', startScanning);
    document.getElementById('stopScan').addEventListener('click', stopScanning);
    document.getElementById('scanAnother').addEventListener('click', scanAnother);
    document.getElementById('markAttendance').addEventListener('click', markAttendance);
}

function showEmptyState() {
    document.getElementById('scannerSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
}

function showScanner() {
    document.getElementById('scannerSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';
}

function showResults() {
    document.getElementById('scannerSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('emptyState').style.display = 'none';
}

function startScanning() {
    showDebug('Starting QR scanner...');
    const video = document.getElementById('scanner');
    
    // Check if QR Scanner library is loaded
    if (typeof QrScanner === 'undefined') {
        showDebug('QR Scanner library not loaded');
        alert('QR Scanner library not loaded. Please refresh the page.');
        return;
    }
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Try different camera constraints
        const constraints = [
            { video: { facingMode: 'environment' } },
            { video: { facingMode: 'user' } },
            { video: true }
        ];
        
        let constraintIndex = 0;
        
        function tryNextConstraint() {
            if (constraintIndex >= constraints.length) {
                alert('Unable to access camera. Please check permissions and try again.');
                return;
            }
            
            navigator.mediaDevices.getUserMedia(constraints[constraintIndex])
                .then(function(stream) {
                    showDebug('Camera access granted with constraint ' + constraintIndex);
                    video.srcObject = stream;
                    video.play();
                    
                    // Wait for video to be ready
                    video.onloadedmetadata = function() {
                        showDebug('Video metadata loaded');
                        
                        // Initialize QR Scanner
                        try {
                            qrScanner = new QrScanner(video, function(result) {
                                showDebug('QR Code detected: ' + result.data);
                                handleQRResult(result);
                            }, {
                                highlightScanRegion: true,
                                highlightCodeOutline: true,
                                preferredCamera: 'environment'
                            });
                            
                            qrScanner.start().then(() => {
                                showDebug('QR Scanner started successfully');
                                isScanning = true;
                                
                                // Update UI
                                document.getElementById('startScan').style.display = 'none';
                                document.getElementById('startScanEmpty').style.display = 'none';
                                document.getElementById('stopScan').style.display = 'inline-block';
                                
                                showScanner();
                            }).catch(err => {
                                console.error('Error starting QR scanner, trying fallback:', err);
                                // Try fallback method
                                startFallbackScanning(video);
                                isScanning = true;
                                
                                // Update UI
                                document.getElementById('startScan').style.display = 'none';
                                document.getElementById('startScanEmpty').style.display = 'none';
                                document.getElementById('stopScan').style.display = 'inline-block';
                                
                                showScanner();
                            });
                            
                        } catch (err) {
                            console.error('Error creating QR scanner:', err);
                            alert('Error creating QR scanner: ' + err.message);
                        }
                    };
                })
                .catch(function(err) {
                    console.error('Error accessing camera with constraint', constraintIndex, ':', err);
                    constraintIndex++;
                    tryNextConstraint();
                });
        }
        
        tryNextConstraint();
    } else {
        alert('Camera not supported on this device.');
    }
}

function stopScanning() {
    if (qrScanner) {
        qrScanner.stop();
        qrScanner.destroy();
        qrScanner = null;
    }
    
    // Stop fallback scanning
    if (fallbackInterval) {
        clearInterval(fallbackInterval);
        fallbackInterval = null;
    }
    
    const video = document.getElementById('scanner');
    if (video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(track => track.stop());
        video.srcObject = null;
    }
    
    isScanning = false;
    
    // Update UI
    document.getElementById('startScan').style.display = 'inline-block';
    document.getElementById('stopScan').style.display = 'none';
    
    showEmptyState();
}

// Fallback QR scanning using jsQR
function startFallbackScanning(video) {
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    fallbackInterval = setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
                console.log('QR Code detected (fallback):', code);
                handleQRResult({ data: code.data });
            }
        }
    }, 100);
}

function handleQRResult(result) {
    console.log('QR Code detected:', result);
    
    // Stop scanning
    stopScanning();
    
    // Parse QR data
    const qrData = parseQRData(result.data);
    
    // Display results
    displayResults(qrData);
    
    // Show results section
    showResults();
}

function parseQRData(data) {
    // Expected format: "mode=class;class_id=1;t=1234567890;teacher_roll_no=T001;subject_id=SUB101"
    const parts = data.split(';');
    const result = {};
    
    parts.forEach(part => {
        const [key, value] = part.split('=');
        if (key && value) {
            result[key] = value;
        }
    });
    
    return result;
}

function displayResults(qrData) {
    // Display QR data
    document.getElementById('qrData').textContent = JSON.stringify(qrData, null, 2);
    document.getElementById('qrMode').textContent = qrData.mode || 'N/A';
    document.getElementById('qrClassId').textContent = qrData.class_id || 'N/A';
    document.getElementById('qrTeacherId').textContent = qrData.teacher_roll_no || 'N/A';
    document.getElementById('qrSubjectId').textContent = qrData.subject_id || 'N/A';
    document.getElementById('qrTimestamp').textContent = qrData.t ? new Date(parseInt(qrData.t) * 1000).toLocaleString() : 'N/A';
    
    // Display student information
    document.getElementById('studentId').textContent = studentInfo.id;
    document.getElementById('studentName').textContent = studentInfo.name;
    document.getElementById('studentRoll').textContent = studentInfo.rollNumber;
    document.getElementById('studentGroup').textContent = studentInfo.group;
    document.getElementById('scanTime').textContent = new Date().toLocaleString();
}

function scanAnother() {
    showEmptyState();
}

function markAttendance() {
    // Here you would typically send the attendance data to the server
    alert('Attendance marked successfully!');
    showEmptyState();
}

// Clean up when page unloads
window.addEventListener('beforeunload', function() {
    if (qrScanner) {
        qrScanner.stop();
        qrScanner.destroy();
    }
});
</script>
{% endblock %}