{% extends 'student/base.html' %}
{% block title %}Signup{% endblock %}

{% block content %}
<style>
body {
    margin: 0;
    font-family: 'Inter', 'Segoe UI', sans-serif;
    background-color: #f4f6f9;
    height: 100vh;
}

.signup-wrapper {
    display: flex;
    height: 85vh;
}

/* Left branding */
.signup-left {
    flex: 1;
    background: linear-gradient(135deg, #1e3a8a, #2563eb);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.signup-left .logo {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 15px;
}

.signup-left p {
    font-size: 0.85rem;
    line-height: 1.4;
    text-align: center;
    max-width: 300px;
    opacity: 0.9;
}

/* Right form */
.signup-right {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 30px;
    background: #ffffff;
    overflow-y: auto;
}

.signup-card {
    width: 100%;
    max-width: 400px;
}

.signup-card h2 {
    text-align: center;
    color: #1e3a8a;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 20px;
}

.form-label {
    font-size: 0.85rem;
    font-weight: 500;
    color: #333;
}

.form-control, .form-select {
    font-size: 0.85rem;
    border-radius: 6px;
    padding: 8px 10px;
    border: 1px solid #d1d5db;
    background-color: #fafafa;
    margin-bottom: 8px;
}

.btn-primary {
    width: 100%;
    padding: 10px;
    font-size: 0.9rem;
    border-radius: 6px;
    font-weight: 500;
    background: #2563eb;
    color: white;
    border: none;
    transition: 0.3s;
}

.btn-primary:hover { background: #1e40af; }

.btn-outline-primary, .btn-outline-secondary {
    border-radius: 6px;
    font-size: 0.8rem;
}

#camera, #snapshot {
    width: 320px;
    height: 240px;
    border: 1px solid #ccc;
    border-radius: 6px;
}

.small {
    font-size: 0.75rem;
    color: #6c757d;
}

@media (max-width: 768px) {
    .signup-wrapper { flex-direction: column; }
    .signup-left { height: 25vh; padding: 15px; }
    .signup-right { height: 75vh; padding: 15px; }
}
</style>

<div class="signup-wrapper">
    <div class="signup-left">
        <div class="logo">AttendEase</div>
        <p>Secure attendance management for your college. Sign up to start managing attendance efficiently.</p>
    </div>

    <div class="signup-right">
        <div class="signup-card">
            <h2>Create Account</h2>

            {% if form and form.errors %}
            <div class="alert alert-danger" style="font-size:0.8rem;">
                {% if form.non_field_errors %}
                    {% for err in form.non_field_errors %}
                        <div>{{ err }}</div>
                    {% endfor %}
                {% endif %}
                {% for field, errors in form.errors.items %}
                    {% for err in errors %}
                        <div><strong>{{ field|capfirst }}:</strong> {{ err }}</div>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <form method="post">
                {% csrf_token %}
                <div class="mb-2">
                    <label class="form-label">Roll Number</label>
                    <input type="text" name="username" class="form-control" placeholder="Enter Roll Number" required>
                </div>

                <div class="mb-2">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-control" placeholder="Enter Email" required>
                </div>

                <div class="mb-2">
                    <label class="form-label">Role</label>
                    <select name="role" class="form-select" id="role-select" required>
                        <option value="student">Student</option>
                        <option value="faculty">Faculty</option>
                    </select>
                </div>

                <div class="mb-2" id="faculty-code-field" style="display:none;">
                    <label class="form-label">Faculty Access Code</label>
                    <input type="text" name="faculty_code" class="form-control" placeholder="Enter Access Code">
                </div>

                <div class="mb-2" id="faculty-roll-field" style="display:none;">
                    <label class="form-label">Faculty Roll No</label>
                    <input type="text" name="faculty_roll_no" class="form-control" placeholder="Enter Roll No">
                </div>

                <div class="mb-2" id="student-group-field">
                    <label class="form-label">Class/Group</label>
                    <select name="student_group" class="form-select">
                        {% for g in form.fields.student_group.queryset %}
                            <option value="{{ g.id }}">{{ g.stream }} - {{ g.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-2" id="student-roll-field">
                    <label class="form-label">Username</label>
                    <input type="text" name="student_roll_no" class="form-control" placeholder="Enter Username">
                </div>

                <div class="mb-2">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-control" placeholder="Enter Password" required>
                </div>

                <div class="mb-2">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" name="confirm_password" class="form-control" placeholder="Confirm Password" required>
                </div>

                <!-- Face capture -->
                <div class="mb-2">
                    <label class="form-label">Capture Face</label>
                    <div class="d-flex flex-column gap-2">
                        <video id="camera" autoplay playsinline></video>
                        <canvas id="snapshot" style="display:none;"></canvas>
                        <div class="small" id="liveness-instruction"></div>
                        <div class="small" id="liveness-status"></div>
                        <div>
                            <button type="button" id="start-camera" class="btn btn-secondary btn-sm">Start Camera</button>
                            <button type="button" id="capture" class="btn btn-outline-primary btn-sm" disabled>Capture</button>
                            <button type="button" id="retake" class="btn btn-outline-secondary btn-sm" style="display:none;">Retake</button>
                        </div>
                    </div>
                    <input type="hidden" name="face_image_data" id="face_image_data">
                    <input type="hidden" name="face_encoding" id="face_encoding">
                </div>

                <button type="submit" class="btn btn-primary mt-2">Sign Up</button>
                <p class="mt-2 text-center" style="font-size:0.8rem;">
                    Already have an account? <a href="{% url 'login' %}">Login here</a>
                </p>
            </form>
        </div>
    </div>
</div>

<script>
// Role select
document.getElementById('role-select').addEventListener('change', function() {
    const isFaculty = this.value === 'faculty';
    document.getElementById('faculty-code-field').style.display = isFaculty ? 'block' : 'none';
    document.getElementById('faculty-roll-field').style.display = isFaculty ? 'block' : 'none';
    document.getElementById('student-group-field').style.display = isFaculty ? 'none' : 'block';
    document.getElementById('student-roll-field').style.display = isFaculty ? 'none' : 'block';
});

// Camera & liveness JS (original)
const startBtn = document.getElementById('start-camera');
const captureBtn = document.getElementById('capture');
const retakeBtn = document.getElementById('retake');
const video = document.getElementById('camera');
const canvas = document.getElementById('snapshot');
const hiddenInput = document.getElementById('face_image_data');
const faceEncodingInput = document.getElementById('face_encoding');
const liveInstruction = document.getElementById('liveness-instruction');
const liveStatus = document.getElementById('liveness-status');
let streamRef = null;
let livenessPassed = false;
let stopLiveness = null;

startBtn.addEventListener('click', async () => {
    try {
        streamRef = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = streamRef;
        startLivenessCheck();
    } catch (e) {
        alert('Unable to access camera. Please allow camera permissions and use localhost or HTTPS.');
    }
});

captureBtn.addEventListener('click', async () => {
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/png');
    hiddenInput.value = dataUrl;
    
    // Generate face encoding (simplified)
    try {
        const faceEncoding = await generateFaceEncoding(dataUrl);
        if (faceEncoding) {
            faceEncodingInput.value = JSON.stringify(faceEncoding);
        } else {
            alert('Failed to generate face encoding. Please try again.');
            return;
        }
    } catch (error) {
        alert('Error generating face encoding. Please try again.');
        return;
    }

    canvas.style.display = 'block';
    video.style.display = 'none';
    retakeBtn.style.display = 'inline-block';
});

retakeBtn.addEventListener('click', () => {
    hiddenInput.value = '';
    faceEncodingInput.value = '';
    canvas.style.display = 'none';
    video.style.display = 'block';
    retakeBtn.style.display = 'none';
});

// Form submit check
const formEl = document.querySelector('form');
formEl.addEventListener('submit', (e) => {
    if (!hiddenInput.value || !faceEncodingInput.value) {
        e.preventDefault();
        alert('Please capture your face before signing up.');
    }
});

// Liveness check function
function startLivenessCheck() {
    const challenges = [
        { key: 'left', text: 'Turn your head LEFT' },
        { key: 'right', text: 'Turn your head RIGHT' },
        { key: 'closer', text: 'Move CLOSER to the camera' },
        { key: 'farther', text: 'Move FARTHER from the camera' }
    ];
    const challenge = challenges[Math.floor(Math.random() * challenges.length)];
    liveInstruction.textContent = challenge.text;
    liveStatus.textContent = 'Liveness check running...';
    liveStatus.style.color = '#6c757d';

    const FaceDet = window.FaceDetector ? new window.FaceDetector({ fastMode: true, maxDetectedFaces: 1 }) : null;
    let lastX = null, lastWidth = null;
    const widthHistory = [];
    const xHistory = [];
    let consecutiveFace = 0;

    const tick = async () => {
        if (!streamRef) return;
        try {
            let faceBox = null;
            if (FaceDet) {
                const faces = await FaceDet.detect(video);
                if (faces && faces.length > 0) {
                    const b = faces[0].boundingBox || faces[0].boundingClientRect || faces[0];
                    faceBox = { x: b.x, y: b.y, width: b.width, height: b.height };
                }
            } else {
                const tmp = document.createElement('canvas');
                tmp.width = video.videoWidth || 320;
                tmp.height = video.videoHeight || 240;
                const tctx = tmp.getContext('2d');
                tctx.drawImage(video, 0, 0, tmp.width, tmp.height);
                faceBox = { x: 0, y: 0, width: tmp.width, height: tmp.height };
            }

            if (faceBox) {
                consecutiveFace++;
                const centerX = faceBox.x + faceBox.width / 2;
                xHistory.push(centerX);
                widthHistory.push(faceBox.width);

                if (xHistory.length > 20) xHistory.shift();
                if (widthHistory.length > 20) widthHistory.shift();

                if (xHistory.length >= 10 && widthHistory.length >= 10) {
                    const dx = centerX - (lastX ?? centerX);
                    const dw = faceBox.width - (lastWidth ?? faceBox.width);
                    lastX = centerX;
                    lastWidth = faceBox.width;

                    const xMin = Math.min(...xHistory);
                    const xMax = Math.max(...xHistory);
                    const wMin = Math.min(...widthHistory);
                    const wMax = Math.max(...widthHistory);
                    const xRange = xMax - xMin;
                    const wRatio = wMax / Math.max(1, wMin);

                    const movedLeft = dx < -2 || (xRange > 30 && (xHistory[0] - xHistory[xHistory.length - 1]) > 10);
                    const movedRight = dx > 2 || (xRange > 30 && (xHistory[xHistory.length - 1] - xHistory[0]) > 10);
                    const movedCloser = wRatio > 1.2;
                    const movedFarther = wRatio < 0.85;

                    let ok = false;
                    if (challenge.key === 'left') ok = movedLeft;
                    if (challenge.key === 'right') ok = movedRight;
                    if (challenge.key === 'closer') ok = movedCloser;
                    if (challenge.key === 'farther') ok = movedFarther;

                    if (ok && consecutiveFace > 8) {
                        livenessPassed = true;
                        liveStatus.textContent = 'Liveness check passed';
                        liveStatus.style.color = '#198754';
                        captureBtn.disabled = false;
                        if (stopLiveness) stopLiveness();
                        return;
                    }
                }
            } else {
                consecutiveFace = 0;
            }
        } catch (err) { }
        raf = requestAnimationFrame(tick);
    };
    let raf = requestAnimationFrame(tick);
    stopLiveness = () => cancelAnimationFrame(raf);
}

// Face encoding function
async function generateFaceEncoding(dataUrl) {
    try {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        return new Promise((resolve, reject) => {
            img.onload = function() {
                try {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = 100; tempCanvas.height = 100;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(img, 0, 0, 100, 100);
                    const imageData = tempCtx.getImageData(0,0,100,100);
                    const data = imageData.data;
                    const features = [];
                    for (let i =0;i<data.length;i+=4){
                        const gray = (data[i]+data[i+1]+data[i+2])/3;
                        features.push(gray/255);
                    }
                    const mean = features.reduce((a,b)=>a+b,0)/features.length;
                    const variance = features.reduce((a,b)=>a+Math.pow(b-mean,2),0)/features.length;
                    const std = Math.sqrt(variance);
                    features.push(mean,variance,std);
                    const histogram = new Array(32).fill(0);
                    for (let i=0;i<features.length-3;i++){
                        const bin = Math.floor(features[i]*31);
                        histogram[bin]++;
                    }
                    const histSum = histogram.reduce((a,b)=>a+b,0);
                    for(let i=0;i<histogram.length;i++) histogram[i]/=histSum;
                    features.push(...histogram);
                    resolve(features);
                } catch(e){reject(e);}
            };
            img.onerror = function(){reject(new Error('Failed to load image'));}
            img.src = dataUrl;
        });
    } catch(e){return null;}
}
</script>

{% endblock %}
