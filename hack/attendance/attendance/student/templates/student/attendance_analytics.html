<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Attendance Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .analytics-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .page-header {
            background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-3px);
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .badge-present { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .badge-absent { background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); }
        .badge-late { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: #000; }
        .badge-excused { background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); }
        .progress-bar-custom {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .trend-day {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 2px;
            text-align: center;
            line-height: 30px;
            font-size: 12px;
            font-weight: bold;
        }
        .trend-present { background: #28a745; color: white; }
        .trend-absent { background: #dc3545; color: white; }
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        }
        .tab-content {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="analytics-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-chart-line me-3"></i>Comprehensive Attendance Analytics</h1>
                <p class="mb-0">Detailed insights into your attendance patterns and performance</p>
            </div>

            <!-- Overall Statistics -->
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card text-center">
                        <i class="fas fa-percentage stat-icon text-success"></i>
                        <div class="stat-value text-success">{{ overall_attendance|default:0 }}%</div>
                        <h5>Overall Attendance</h5>
                        <small class="text-muted">All Time ({{ total_records|default:0 }} classes)</small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card text-center">
                        <i class="fas fa-calendar-week stat-icon text-info"></i>
                        <div class="stat-value text-info">{{ weekly_attendance|default:0 }}%</div>
                        <h5>Weekly Attendance</h5>
                        <small class="text-muted">Last 7 days ({{ weekly_present|default:0 }}/{{ weekly_total|default:0 }})</small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card text-center">
                        <i class="fas fa-calendar-alt stat-icon text-warning"></i>
                        <div class="stat-value text-warning">{{ monthly_attendance|default:0 }}%</div>
                        <h5>Monthly Attendance</h5>
                        <small class="text-muted">Last 30 days ({{ monthly_present|default:0 }}/{{ monthly_total|default:0 }})</small>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stats-card text-center">
                        <i class="fas fa-fire stat-icon text-danger"></i>
                        <div class="stat-value text-danger">{{ current_streak|default:0 }}</div>
                        <h5>Current Streak</h5>
                        <small class="text-muted">Longest: {{ longest_streak|default:0 }} days</small>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-pills nav-fill mb-4" id="analyticsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Overview
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trends-tab" data-bs-toggle="pill" data-bs-target="#trends" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Trends
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="subjects-tab" data-bs-toggle="pill" data-bs-target="#subjects" type="button" role="tab">
                        <i class="fas fa-book me-2"></i>Subjects
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="patterns-tab" data-bs-toggle="pill" data-bs-target="#patterns" type="button" role="tab">
                        <i class="fas fa-calendar-check me-2"></i>Patterns
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="details-tab" data-bs-toggle="pill" data-bs-target="#details" type="button" role="tab">
                        <i class="fas fa-table me-2"></i>Details
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="analyticsTabsContent">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="row">
                        <!-- Attendance Progress -->
                        <div class="col-lg-8">
                            <div class="stats-card">
                                <h3><i class="fas fa-chart-bar me-2"></i>Attendance Progress</h3>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar progress-bar-custom" role="progressbar" 
                                         style="width: {{ overall_attendance|default:0 }}%" aria-valuenow="{{ overall_attendance|default:0 }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ overall_attendance|default:0 }}% Overall
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="h5 text-success">{{ total_present|default:0 }}</div>
                                            <small class="text-muted">Present Days</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="h5 text-danger">{{ total_absent|default:0 }}</div>
                                            <small class="text-muted">Absent Days</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="h5 text-info">{{ total_records|default:0 }}</div>
                                            <small class="text-muted">Total Classes</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="col-lg-4">
                            <div class="stats-card">
                                <h3><i class="fas fa-trophy me-2"></i>Quick Stats</h3>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Weekly Rate:</span>
                                        <span class="fw-bold text-info">{{ weekly_attendance|default:0 }}%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Monthly Rate:</span>
                                        <span class="fw-bold text-warning">{{ monthly_attendance|default:0 }}%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Quarterly Rate:</span>
                                        <span class="fw-bold text-primary">{{ quarterly_attendance|default:0 }}%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Current Streak:</span>
                                        <span class="fw-bold text-danger">{{ current_streak|default:0 }} days</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trends Tab -->
                <div class="tab-pane fade" id="trends" role="tabpanel">
                    <div class="row">
                        <!-- Weekly Trend -->
                        <div class="col-lg-6">
                            <div class="stats-card">
                                <h3><i class="fas fa-chart-line me-2"></i>Weekly Trend (Last 7 Days)</h3>
                                <div class="text-center mb-3">
                                    {% for day in weekly_trend %}
                                    <div class="trend-day {% if day.status == 'present' %}trend-present{% else %}trend-absent{% endif %}" 
                                         title="{{ day.day_name }} - {{ day.status|title }}">
                                        {{ day.date }}
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="text-center">
                                    <span class="badge bg-info">Weekly Rate: {{ weekly_attendance|default:0 }}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monthly Trend -->
                        <div class="col-lg-6">
                            <div class="stats-card">
                                <h3><i class="fas fa-chart-area me-2"></i>Monthly Trend (Last 30 Days)</h3>
                                <div class="chart-container">
                                    <canvas id="monthlyTrendChart"></canvas>
                                </div>
                                <div class="text-center mt-3">
                                    <span class="badge bg-warning">Monthly Rate: {{ monthly_attendance|default:0 }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Breakdown -->
                    {% if monthly_breakdown %}
                    <div class="stats-card">
                        <h3><i class="fas fa-calendar-alt me-2"></i>Monthly Breakdown</h3>
                        <div class="row">
                            {% for month_key, stats in monthly_breakdown.items %}
                            <div class="col-md-4 col-lg-3 mb-3">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">{{ stats.name }}</h6>
                                        <div class="h4 {% if stats.rate >= 80 %}text-success{% elif stats.rate >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ stats.rate }}%
                                        </div>
                                        <small class="text-muted">
                                            {{ stats.present }}/{{ stats.total }} classes
                                        </small>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar {% if stats.rate >= 80 %}bg-success{% elif stats.rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ stats.rate }}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Subjects Tab -->
                <div class="tab-pane fade" id="subjects" role="tabpanel">
                    {% if subject_stats %}
                    <div class="stats-card">
                        <h3><i class="fas fa-book me-2"></i>Subject-wise Attendance</h3>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Subject</th>
                                        <th>Overall</th>
                                        <th>Weekly</th>
                                        <th>Monthly</th>
                                        <th>Present/Total</th>
                                        <th>Progress</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for subject_code, stats in subject_stats.items %}
                                    <tr>
                                        <td><strong>{{ stats.display_name }}</strong></td>
                                        <td>
                                            <span class="badge {% if stats.overall_rate >= 80 %}badge-present{% elif stats.overall_rate >= 60 %}badge-late{% else %}badge-absent{% endif %}">
                                                {{ stats.overall_rate }}%
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if stats.weekly_rate >= 80 %}badge-present{% elif stats.weekly_rate >= 60 %}badge-late{% else %}badge-absent{% endif %}">
                                                {{ stats.weekly_rate }}%
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if stats.monthly_rate >= 80 %}badge-present{% elif stats.monthly_rate >= 60 %}badge-late{% else %}badge-absent{% endif %}">
                                                {{ stats.monthly_rate }}%
                                            </span>
                                        </td>
                                        <td>{{ stats.present }}/{{ stats.total }}</td>
                                        <td>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar {% if stats.overall_rate >= 80 %}bg-success{% elif stats.overall_rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                     style="width: {{ stats.overall_rate }}%"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if teacher_stats %}
                    <div class="stats-card">
                        <h3><i class="fas fa-chalkboard-teacher me-2"></i>Teacher-wise Attendance</h3>
                        <div class="row">
                            {% for teacher_name, stats in teacher_stats.items %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">{{ teacher_name }}</h6>
                                        <div class="h4 {% if stats.rate >= 80 %}text-success{% elif stats.rate >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ stats.rate }}%
                                        </div>
                                        <small class="text-muted">
                                            {{ stats.present }}/{{ stats.total }} classes
                                        </small>
                                        <div class="progress mt-2" style="height: 8px;">
                                            <div class="progress-bar {% if stats.rate >= 80 %}bg-success{% elif stats.rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ stats.rate }}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Patterns Tab -->
                <div class="tab-pane fade" id="patterns" role="tabpanel">
                    {% if day_patterns %}
                    <div class="stats-card">
                        <h3><i class="fas fa-calendar-check me-2"></i>Day of Week Patterns</h3>
                        <div class="row">
                            {% for day_name, stats in day_patterns.items %}
                            <div class="col-md-4 col-lg-2 mb-3">
                                <div class="card border-0 bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">{{ day_name }}</h6>
                                        <div class="h4 {% if stats.rate >= 80 %}text-success{% elif stats.rate >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ stats.rate }}%
                                        </div>
                                        <small class="text-muted">
                                            {{ stats.present }}/{{ stats.total }}
                                        </small>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar {% if stats.rate >= 80 %}bg-success{% elif stats.rate >= 60 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ stats.rate }}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Attendance Streaks -->
                    <div class="stats-card">
                        <h3><i class="fas fa-fire me-2"></i>Attendance Streaks</h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="text-center p-4 bg-light rounded">
                                    <i class="fas fa-fire fa-3x text-danger mb-3"></i>
                                    <div class="h2 text-danger">{{ current_streak|default:0 }}</div>
                                    <h5>Current Streak</h5>
                                    <small class="text-muted">Days in a row</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-4 bg-light rounded">
                                    <i class="fas fa-trophy fa-3x text-warning mb-3"></i>
                                    <div class="h2 text-warning">{{ longest_streak|default:0 }}</div>
                                    <h5>Longest Streak</h5>
                                    <small class="text-muted">Best performance</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Details Tab -->
                <div class="tab-pane fade" id="details" role="tabpanel">
                    <div class="stats-card">
                        <h3><i class="fas fa-table me-2"></i>Detailed Attendance Record (Last 30 Days)</h3>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Subject</th>
                                        <th>Teacher</th>
                                        <th>Class</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                        <th>Face Verified</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if records and records|length > 0 %}
                                        {% for r in records %}
                                        <tr>
                                            <td>{{ r.date }}</td>
                                            <td>{{ r.subject }}</td>
                                            <td>{{ r.teacher }}</td>
                                            <td>{{ r.class }}</td>
                                            <td>
                                                {% if r.status == 'Present' %}
                                                    <span class="badge badge-present">Present</span>
                                                {% elif r.status == 'Absent' %}
                                                    <span class="badge badge-absent">Absent</span>
                                                {% elif r.status == 'Late' %}
                                                    <span class="badge badge-late">Late</span>
                                                {% else %}
                                                    <span class="badge badge-excused">{{ r.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ r.time }}</td>
                                            <td class="text-center">{{ r.face_verified }}</td>
                                            <td>{{ r.notes }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                No attendance records yet. Start by scanning a QR code!
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <a href="/scan/" class="btn btn-success btn-lg me-3">
                        <i class="fas fa-qrcode me-2"></i>Scan QR Code
                    </a>
                    <a href="/student-dashboard/" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-home me-2"></i>Back to Dashboard
                    </a>
                    <a href="/logout/" class="btn btn-outline-danger btn-lg">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Monthly Trend Chart
        const monthlyTrendData = {{ monthly_trend|safe }};
        const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyTrendData.map(day => day.date),
                datasets: [{
                    label: 'Attendance',
                    data: monthlyTrendData.map(day => day.present),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        ticks: {
                            callback: function(value) {
                                return value === 1 ? 'Present' : 'Absent';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    </script>
</body>
</html>