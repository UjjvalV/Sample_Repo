<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Analytics - {{ class_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .analytics-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .stat-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        }
        .stat-card .card-body {
            padding: 25px;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card p {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.9;
            margin: 0;
        }
        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .chart-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }
        .chart-header h5 {
            margin: 0;
            color: #495057;
            font-weight: 600;
        }
        .chart-header i {
            color: #667eea;
            margin-right: 10px;
            font-size: 1.2rem;
        }
        .quick-actions {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-action {
            border-radius: 15px;
            padding: 12px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            margin-bottom: 10px;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .class-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        .class-info h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .class-info li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .class-info li:last-child {
            border-bottom: none;
        }
        .class-info i {
            color: #667eea;
            width: 20px;
        }
        .absent-students {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .absent-item {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #e53e3e;
            transition: all 0.3s ease;
        }
        .absent-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .page-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .page-title h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .page-title p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #667eea;
        }
        .navbar-brand {
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .navbar-brand:hover {
            transform: translateX(-3px);
        }
        .btn-outline-light:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark gradient-bg">
        <div class="container">
            <a class="navbar-brand" href="/analytics/teacher">
                <i class="fas fa-arrow-left me-2"></i>
                Back to Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-chalkboard-teacher me-1"></i>
                    Class {{ class_id }}
                </span>
                <a class="btn btn-outline-light btn-sm" href="/logout/">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="analytics-container">
        <!-- Page Title -->
        <div class="page-title">
            <h1>
                <i class="fas fa-chart-line me-3"></i>
                <span id="class-name">Loading...</span>
            </h1>
            <p>Real-time attendance analytics and insights</p>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-5">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card bg-primary text-white">
                    <div class="card-body">
                        <i class="fas fa-users"></i>
                        <h3 id="total-students">0</h3>
                        <p>Total Students</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card bg-success text-white">
                    <div class="card-body">
                        <i class="fas fa-check-circle"></i>
                        <h3 id="present-today">0</h3>
                        <p>Present Today</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card bg-danger text-white">
                    <div class="card-body">
                        <i class="fas fa-times-circle"></i>
                        <h3 id="absent-today">0</h3>
                        <p>Absent Today</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card bg-warning text-white">
                    <div class="card-body">
                        <i class="fas fa-calendar-week"></i>
                        <h3 id="absent-week">0</h3>
                        <p>Absent This Week</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card bg-info text-white">
                    <div class="card-body">
                        <i class="fas fa-percentage"></i>
                        <h3 id="attendance-rate-today">0%</h3>
                        <p>Today's Rate</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card stat-card bg-secondary text-white">
                    <div class="card-body">
                        <i class="fas fa-chart-line"></i>
                        <h3 id="attendance-rate-week">0%</h3>
                        <p>Weekly Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Actions -->
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="chart-container">
                    <div class="chart-header">
                        <i class="fas fa-chart-line"></i>
                        <h5>7-Day Attendance Trend</h5>
                    </div>
                    <div class="loading-spinner" id="chart-loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <canvas id="attendanceChart" style="display: none;" height="100"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="quick-actions">
                    <div class="chart-header">
                        <i class="fas fa-tasks"></i>
                        <h5>Quick Actions</h5>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="/analytics/qr/?class_id={{ class_id }}" class="btn btn-success btn-action">
                            <i class="fas fa-qrcode me-2"></i>
                            Generate QR Code
                        </a>
                        <button class="btn btn-primary btn-action" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Data
                        </button>
                        <button class="btn btn-info btn-action" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>
                            Export Report
                        </button>
                        <a href="/faculty/notifications/" class="btn btn-warning btn-action">
                            <i class="fas fa-bell me-2"></i>
                            View Notifications
                        </a>
                    </div>
                    
                    <div class="class-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Class Information</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-calendar"></i> <strong>Schedule:</strong> Mon, Wed, Fri</li>
                            <li><i class="fas fa-clock"></i> <strong>Time:</strong> 10:00 AM - 11:30 AM</li>
                            <li><i class="fas fa-map-marker-alt"></i> <strong>Room:</strong> Lab {{ class_id }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Absent Students -->
        <div class="row g-4 mt-4">
            <div class="col-lg-12">
                <div class="absent-students">
                    <div class="chart-header">
                        <i class="fas fa-user-times text-danger"></i>
                        <h5>Absent Students Today</h5>
                    </div>
                    <div id="absent-students-list">
                        <div class="loading-spinner">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-3">Loading absent students...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let attendanceChart;
        const classId = {{ class_id }};

        let isLoading = false;
        let lastDataHash = null;

        async function loadAnalyticsData() {
            // Prevent multiple simultaneous requests
            if (isLoading) {
                console.log('Already loading data, skipping...');
                return;
            }
            
            isLoading = true;
            
            try {
                console.log('Loading analytics data for class:', classId);
                const response = await fetch(`/analytics/api/${classId}/`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Create a hash of the data to check if it's changed
                const dataHash = JSON.stringify({
                    total_students: data.total_students,
                    present_today: data.present_today,
                    absent_today: data.absent_today,
                    attendance_rate_today: data.attendance_rate_today,
                    labels: data.labels,
                    trend_data: data.trend_data
                });
                
                // Only update if data has changed
                if (dataHash === lastDataHash) {
                    console.log('Data unchanged, skipping update');
                    isLoading = false;
                    return;
                }
                
                lastDataHash = dataHash;
                console.log('Received analytics data:', data);
                
                // Update class name
                document.getElementById('class-name').textContent = data.class_name || `Class ${classId}`;
                
                // Update stats with animation
                animateNumber('total-students', data.total_students || 0);
                animateNumber('present-today', data.present_today || 0);
                animateNumber('absent-today', data.absent_today || 0);
                animateNumber('absent-week', data.total_absences_week || 0);
                animatePercentage('attendance-rate-today', data.attendance_rate_today || 0);
                animatePercentage('attendance-rate-week', data.attendance_rate_week || 0);
                
                // Update absent students list
                updateAbsentStudents(data.absent_students_today || []);
                
                // Update charts only if we have valid data
                console.log('Updating charts with data:', data);
                if (data.labels && data.trend_data && data.labels.length > 0 && data.trend_data.length > 0) {
                    updateAttendanceChart(data.labels, data.trend_data);
                } else {
                    console.warn('No valid chart data available');
                    const chartLoading = document.getElementById('chart-loading');
                    chartLoading.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <h5>No Data Available</h5>
                            <p>No attendance data found for the last 7 days.</p>
                        </div>
                    `;
                    chartLoading.style.display = 'block';
                    document.getElementById('attendanceChart').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                // Show error message
                const chartLoading = document.getElementById('chart-loading');
                chartLoading.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>Error Loading Data</h5>
                        <p>Unable to load analytics data. Please try again.</p>
                        <button class="btn btn-primary" onclick="loadAnalyticsData()">
                            <i class="fas fa-refresh me-2"></i>Retry
                        </button>
                    </div>
                `;
                chartLoading.style.display = 'block';
                document.getElementById('attendanceChart').style.display = 'none';
            } finally {
                isLoading = false;
            }
        }
        
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = parseInt(element.textContent) || 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = Math.round(startValue + (targetValue - startValue) * progress);
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }
        
        function animatePercentage(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const startValue = parseFloat(element.textContent) || 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function updatePercentage(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = (startValue + (targetValue - startValue) * progress).toFixed(1);
                element.textContent = currentValue + '%';
                
                if (progress < 1) {
                    requestAnimationFrame(updatePercentage);
                }
            }
            
            requestAnimationFrame(updatePercentage);
        }

        function updateAbsentStudents(absentStudents) {
            const container = document.getElementById('absent-students-list');
            
            if (absentStudents.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-success py-4">
                        <i class="fas fa-check-circle fa-4x mb-3 text-success"></i>
                        <h4 class="text-success">Perfect Attendance!</h4>
                        <p class="text-muted">All students are present today. Great job! ðŸŽ‰</p>
                    </div>
                `;
            } else {
                let html = `<div class="mb-4">
                    <h6 class="text-danger mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${absentStudents.length} students absent today
                    </h6>
                </div>`;
                
                absentStudents.forEach((student, index) => {
                    html += `
                        <div class="absent-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-user-times text-danger me-2"></i>
                                    <strong>${student}</strong>
                                </div>
                                <span class="badge bg-danger rounded-pill">Absent</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }

        function updateAttendanceChart(labels, data) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            const chartLoading = document.getElementById('chart-loading');
            const chartCanvas = document.getElementById('attendanceChart');
            
            // Hide loading spinner and show chart
            chartLoading.style.display = 'none';
            chartCanvas.style.display = 'block';
            
            // Destroy existing chart if it exists
            if (attendanceChart) {
                attendanceChart.destroy();
                attendanceChart = null;
            }
            
            // Validate data
            if (!labels || !data || labels.length === 0 || data.length === 0) {
                console.warn('Invalid chart data:', { labels, data });
                chartLoading.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h5>No Data Available</h5>
                        <p>No attendance data found for the last 7 days.</p>
                    </div>
                `;
                chartLoading.style.display = 'block';
                chartCanvas.style.display = 'none';
                return;
            }
            
            // Ensure data arrays have same length
            const minLength = Math.min(labels.length, data.length);
            const validLabels = labels.slice(0, minLength);
            const validData = data.slice(0, minLength);
            
            console.log('Creating chart with data:', { validLabels, validData });
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(102, 126, 234, 0.3)');
            gradient.addColorStop(1, 'rgba(102, 126, 234, 0.05)');
            
            try {
                attendanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: validLabels,
                        datasets: [{
                            label: 'Attendance %',
                            data: validData,
                            borderColor: '#667eea',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointHoverBackgroundColor: '#764ba2',
                            pointHoverBorderColor: '#ffffff',
                            pointHoverBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#6c757d',
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6c757d',
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#667eea',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: false,
                                callbacks: {
                                    title: function(context) {
                                        return 'Date: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return 'Attendance: ' + context.parsed.y + '%';
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeInOutQuart'
                        },
                        onHover: (event, activeElements) => {
                            event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                        }
                    }
                });
                
                console.log('Chart created successfully');
                
            } catch (error) {
                console.error('Error creating chart:', error);
                chartLoading.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>Chart Error</h5>
                        <p>Unable to render chart. Please refresh the page.</p>
                    </div>
                `;
                chartLoading.style.display = 'block';
                chartCanvas.style.display = 'none';
            }
        }


        function refreshData() {
            console.log('Manual refresh triggered');
            lastDataHash = null; // Force data refresh
            loadAnalyticsData();
        }

        function exportData() {
            alert('Export functionality would be implemented here');
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing analytics...');
            // Add a small delay to ensure all elements are ready
            setTimeout(() => {
                loadAnalyticsData();
            }, 500);
        });
        
        // Auto-refresh every 60 seconds (increased from 30 to reduce load)
        let refreshInterval = setInterval(() => {
            console.log('Auto-refresh triggered');
            loadAnalyticsData();
        }, 60000);
        
        // Clear interval when page is unloaded to prevent memory leaks
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (attendanceChart) {
                attendanceChart.destroy();
            }
        });
    </script>
</body>
</html>
